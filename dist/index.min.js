class EventEmitter{constructor(){this.map=new Map}on(t,e){let s;this.map.has(t)?s=this.map.get(t):(s=new Set,this.map.set(t,s)),s.add(e)}off(t,e){if(!this.map.has(t))return;this.map.get(t).delete(e)}emit(t,e){if(!this.map.has(t))return;const s=this.map.get(t);for(const t of s)t(e)}}const MATCH_ALL="[^/]*",CATCH_ALL="([^/]+)",PARAMETER_PATTERN=/:([^\/]+)/,MATCH_TRAILING_SLASH="(?:[/]?(?=$))?",WILDCARD_PATTERN=/\*\*/g;class Path{constructor(t="",e=!1){this.path=t,this.exact=e;let s,r=t.replace(WILDCARD_PATTERN,MATCH_ALL),n=[];for(;null!=(s=PARAMETER_PATTERN.exec(r));)r=r.replace(s[0],CATCH_ALL),n.push(s[1]);r.endsWith("/")||(r+=MATCH_TRAILING_SLASH),r=e?`^${r}$`:`^${r}`;const i=new RegExp(r,"i");this.keys=n,this.pattern=i}matches(t){return this.pattern.test(t)}matched(t){let e=this.pattern.exec(t);return e&&e[0]||""}parse(t){return new Parameters(t,this.pattern,this.keys)}transfer(t,e){const s=(this.pattern.exec(t)||[]).slice(1);let r=e,n=s.length;for(;n--;)r=r.replace(":"+this.keys[n],s[n]);return r}}class Parameters{constructor(t,e,s){this.path=t,this.keys=s,this.values=(e.exec(t)||[]).slice(1)}get(t){return this.values[this.keys.indexOf(t)]}set(t,e){return this.path.replace(this.get(t),e)}has(t){return void 0!==this.get(t)}entries(){let t=[];for(let e=0;e<this.keys.length;e++)t.push([this.keys[e],this.values[e]]);return t}all(){return this.keys.reduce((t,e,s)=>(t[e]=this.values[s],t),{})}*[Symbol.iterator](){const t=this.keys.length;for(let e=0;e<t;e++)yield[this.keys[e],this.values[e]]}}class Query extends Map{static from(t){return new Query(Object.entries(t))}static parse(t){t.startsWith("?")&&(t=t.substring(1));let e=[];return""!==t&&(e=t.split("&").map(t=>t.split("="))),new Query(e)}toString(){let t="";for(const[e,s]of this)t+=`&${e}=${s}`;return t.substring(1)}}function normalize(t){return("/"+t).replace(/[\/]+/g,"/")}function isFunction(t){if("function"!=typeof t)return!1;const e=t[Symbol.toStringTag];if("AsyncFunction"===e||"GeneratorFunction"===e)return!0;{const e=t.hasOwnProperty("arguments"),s=!t.hasOwnProperty("prototype");return e||s}}function clone(t){return Object.assign({},t)}function freeze(t){return Object.freeze(t)}function always(){return!0}const EMPTY=freeze(Object.create(null));class Route extends Path{static async import(t){if("string"==typeof t)return customElements.get(t);if(isFunction(t)){let e=t(),s=await Promise.resolve(e);return s.default?s.default:s}return t}constructor(t){let{path:e,component:s,exact:r,redirect:n,slot:i,guard:h,meta:a,properties:o,children:c}=t;null==r&&(r=null==c||0===c.length),super(e,r),this.path=e,this.exact=r,this.redirect=n,this.component=s,this.slot=i,this.guard=h||always,this.meta=freeze(a||{}),this.properties=freeze(o||{}),this.children=(c||[]).map(t=>createChildRoute(clone(t),this))}async import(){return null==this.resolved&&(this.resolved=await Route.import(this.component)),this.resolved}snapshot(t){return freeze({parameters:this.parse(t),query:Query.parse(location.search),matched:this.matched(t),hash:location.hash.substring(1)})}}function createChildRoute(t,e){return""===t.path?t.path=e.path:t.path=normalize(e.path+"/"+t.path),null!=t.redirect&&(""===t.redirect?t.redirect=e.path:t.redirect=normalize(e.path+"/"+t.redirect)),new Route(t)}class Router extends EventEmitter{constructor(t){super(),this.isConnected=!1,this.elements=[],this.matched=[],this.middleware=[],this.routes=t.map(t=>new Route(t)),this.onPopstate=this.onPopstate.bind(this),Router.instance=this}async connect(t){this.isConnected=!0,this.target=t,window.addEventListener("popstate",this.onPopstate);const e=decodeURIComponent(location.pathname),{matched:s,path:r}=this.match(e);history.replaceState(history.state,document.title,r),await this.render(s),this.emit("connect")}disconnect(){this.isConnected=!1,window.removeEventListener("popstate",this.onPopstate),this.teardown(),this.matched=[],this.target=void 0,this.emit("disconnect")}onPopstate(){const t=decodeURIComponent(location.pathname),{matched:e,path:s}=this.match(t);t!==s&&history.replaceState(history.state,document.title,s),this.emit("pop"),this.render(e)}push(t,e=EMPTY){t=decodeURIComponent(t);const{matched:s,path:r}=this.match(t),{data:n,title:i}=e;return history.pushState(n,i,r),this.emit("push"),this.render(s)}replace(t,e=EMPTY){t=decodeURIComponent(t);const{matched:s,path:r}=this.match(t),{data:n,title:i}=e;return history.replaceState(n,i,r),this.emit("replace"),this.render(s)}pop(t=-1){history.go(t)}search(t,e,s){const r=e.find(e=>e.matches(t)&&e.guard());if(r){if(s.push(r),r.redirect){const e=r.matched(t),s=r.redirect,n=r.transfer(e,s);return this.search(n,this.routes,[])}return r.children?this.search(t,r.children,s):{matched:s,path:t}}return{matched:s,path:t}}match(t){return this.search(t,this.routes,[])}async render(t){if(void 0==this.target)return;const e=Promise.all(t.map(t=>t.import()));let s;for(let e=0;e<t.length;e++){const r=t[e];if(this.matched.length<e+1){s=e;break}if(r!==this.matched[e]){s=e;break}}null==s&&(s=t.length),this.matched=t;const r=this.elements.slice(s);for(;r.length>0;){r.pop().remove()}this.elements=this.elements.slice(0,s);const n=await e,i=n.slice(s).map(t=>new t);for(let t=0;t<i.length-1;t++){const e=i[t],s=i[t+1];e.appendChild(s)}this.elements=this.elements.concat(i);const h=decodeURIComponent(location.pathname);for(let e=0;e<this.elements.length;e++){const s=this.elements[e],r=t[e],i=n[e],a=r.snapshot(h),o=a.parameters,c=i.properties;if(void 0!=c){for(const[t,e]of o)c.hasOwnProperty(t)&&(s[t]=e);for(const t in r.properties)if(c.hasOwnProperty(t)){const e=r.properties[t];s[t]=e}}s.route=a,r.slot&&s.setAttribute("slot",r.slot)}i.length>0&&(s>0?this.elements[s-1].appendChild(i[0]):this.target.appendChild(this.elements[0])),this.emit("render")}teardown(){for(;this.elements.length>0;){this.elements.pop().remove()}}}export default Router;export{Path,Query,Route};
//# sourceMappingURL=index.min.js.map
